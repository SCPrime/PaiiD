name: 🔍 Auto GitHub Monitor & Health Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_run:
    workflows: ["*"]
    types: [completed]
  issues:
    types: [opened, closed, reopened, labeled]
  schedule:
    # Runs every 5 minutes during active hours (8 AM - 10 PM)
    - cron: '*/5 8-22 * * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of check to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - health
          - issues
          - deployments

permissions:
  contents: write
  issues: write
  pull-requests: read
  deployments: read

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 📦 Install Dependencies
        run: |
          pip install httpx rich pydantic python-dotenv
          echo "✅ Dependencies installed"

      - name: 🔍 Run GitHub Monitor Check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          EVENT_NAME: ${{ github.event_name }}
          RUN_ID: ${{ github.run_id }}
          CHECK_TYPE: ${{ github.event.inputs.check_type || 'all' }}
        run: |
          python scripts/auto_github_monitor.py

      - name: 📊 Update Progress Dashboard
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        run: |
          python scripts/update_dashboard_progress.py
          
      - name: 💾 Commit Dashboard Updates
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add PROGRESS_DASHBOARD.html progress-data.json
            git commit -m "📊 auto: Update progress dashboard [skip ci]" || echo "No changes to commit"
            git push || echo "Nothing to push"
          else
            echo "✅ No dashboard changes needed"
          fi

      - name: 🚨 Check for Critical Issues
        if: always()
        run: |
          python scripts/check_critical_issues.py

      - name: 📢 Post Summary
        if: always()
        run: |
          echo "## 🔍 Monitor Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ✅ Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View full monitor dashboard: [Progress Dashboard](https://scprime.github.io/PaiiD/)" >> $GITHUB_STEP_SUMMARY

