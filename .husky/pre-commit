#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ====================================
# PAIID PRE-COMMIT VALIDATION PIPELINE
# ====================================
# This hook validates code quality AND protects reference files
# It runs automatically before every git commit

echo "üîç Running pre-commit validation..."

# ====================================
# PHASE 1: LOCKED FINAL FILE PROTECTION
# ====================================

echo "üîí Phase 1: Checking for LOCKED FINAL file modifications..."

# Check if any LOCKED FINAL files are staged for commit
LOCKED_FILES=$(git diff --cached --name-only | grep -E "LOCKED FINAL|Locked\.tsx|Locked\.svg|CompletePaiiDLogo|PaiiDChatBoxLocked|iPi-Symbol-Locked")

if [ -n "$LOCKED_FILES" ]; then
  echo ""
  echo "‚ùå ==================== COMMIT BLOCKED ===================="
  echo "üîí **ERROR:** You are attempting to commit PROTECTED REFERENCE FILES"
  echo ""
  echo "üìÅ Protected files detected:"
  echo "$LOCKED_FILES" | sed 's/^/   /'
  echo ""
  echo "üö´ **RULES - NO EXCEPTIONS:**"
  echo "   1. These files are READ-ONLY REFERENCES"
  echo "   2. DO NOT MODIFY, REFACTOR, or \"IMPROVE\""
  echo "   3. COPY ONLY - Never edit the original"
  echo "   4. NO REFORMATTING - Keep exact spacing/styling"
  echo ""
  echo "üí° **To proceed (NOT recommended):**"
  echo "   git commit --no-verify -m \"your message\""
  echo ""
  echo "‚úÖ **Recommended action:**"
  echo "   1. Unstage the protected files: git reset HEAD <file>"
  echo "   2. Revert changes: git checkout -- <file>"
  echo "   3. Copy the file to a new location instead"
  echo ""
  echo "**Status:** IMMUTABLE | **Approved By:** Dr. SC Prime ‚úÖ"
  echo "========================================================"
  echo ""
  exit 1
fi

echo "‚úÖ No LOCKED FINAL files modified."

# ====================================
# PHASE 2: DETECT CHANGED FILES
# ====================================

# Detect what files are staged
FRONTEND_FILES=$(git diff --cached --name-only | grep "^frontend/")
BACKEND_FILES=$(git diff --cached --name-only | grep "^backend/")
DOC_ONLY=$(git diff --cached --name-only | grep -v "^frontend/" | grep -v "^backend/" | grep "\.md$")

# If only docs changed, skip validation
if [ -z "$FRONTEND_FILES" ] && [ -z "$BACKEND_FILES" ] && [ -n "$DOC_ONLY" ]; then
  echo "üìù Only documentation files changed, skipping code validation."
  echo "‚úÖ All pre-commit checks passed!"
  exit 0
fi

# ====================================
# PHASE 3: FRONTEND VALIDATION
# ====================================

if [ -n "$FRONTEND_FILES" ]; then
  echo "üì¶ Phase 3a: Frontend files detected, running validation..."
  cd frontend

  echo "üé® Running lint-staged..."
  npx lint-staged
  if [ $? -ne 0 ]; then
    echo "‚ùå Frontend lint-staged failed!"
    exit 1
  fi

  echo "üîß Type checking..."
  npm run type-check
  if [ $? -ne 0 ]; then
    echo "‚ùå Frontend type-check failed! Fix TypeScript errors before committing."
    exit 1
  fi

  cd ..
  echo "‚úÖ Frontend validation passed."
else
  echo "‚è≠Ô∏è  No frontend files changed, skipping frontend validation."
fi

# ====================================
# PHASE 4: BACKEND VALIDATION
# ====================================

if [ -n "$BACKEND_FILES" ]; then
  echo "üêç Phase 4a: Backend files detected, running validation..."
  cd backend

  echo "üîç Running Ruff linter..."
  ruff check . --fix
  if [ $? -ne 0 ]; then
    echo "‚ùå Backend Ruff linting failed! Fix Python errors before committing."
    exit 1
  fi

  echo "üé® Running Ruff formatter..."
  ruff format .
  if [ $? -ne 0 ]; then
    echo "‚ùå Backend Ruff formatting failed!"
    exit 1
  fi

  cd ..
  echo "‚úÖ Backend validation passed."
else
  echo "‚è≠Ô∏è  No backend files changed, skipping backend validation."
fi

# ====================================
# SUCCESS
# ====================================

echo "‚úÖ All pre-commit checks passed!"
exit 0
